var jsonObject = { "type": "FeatureCollection", "features": [{ "type": "Feature", "properties": { "Country/Region": "France", "Province/State": "Île-de-France", "Code": "11", "Population": { "Total": 12278210, "Under19": 3140965, "Under39": 3409765, "Under59": 3210447, "Under74": 1658207, "Over75": 858826 }, "Beds": { "Resuscitation": 1147, "IntensiveCare": 2512, "Total": 3659 }, "Deaths": 2107, "Recovered": 5166, "Severe": 11474, "Critical": 2506, "Confirmed": 7660, "Emergencies": { "Suspected": 2054, "Total": 8124, "Severe": 716 }, "MedicalActs": { "Suspected": 518, "Total": 2627 } }, "geometry": { "type": "Point", "coordinates": [2.5292589766081885, 48.704415292397634] } }, { "type": "Feature", "properties": { "Country/Region": "France", "Province/State": "Centre-Val de Loire", "Code": "24", "Population": { "Total": 2559073, "Under19": 598570, "Under39": 541141, "Under59": 661150, "Under74": 478923, "Over75": 279289 }, "Beds": { "Resuscitation": 180, "IntensiveCare": 346, "Total": 526 }, "Deaths": 115, "Recovered": 298, "Severe": 751, "Critical": 194, "Confirmed": 1157, "Emergencies": { "Suspected": 122, "Total": 1787, "Severe": 48 }, "MedicalActs": { "Suspected": 33, "Total": 568 } }, "geometry": { "type": "Point", "coordinates": [1.6429664800000017, 47.54357092799999] } }, { "type": "Feature", "properties": { "Country/Region": "France", "Province/State": "Bourgogne-Franche-Comté", "Code": "27", "Population": { "Total": 2783039, "Under19": 627017, "Under39": 591411, "Under59": 715664, "Under74": 540051, "Over75": 308896 }, "Beds": { "Resuscitation": 198, "IntensiveCare": 642, "Total": 840 }, "Deaths": 341, "Recovered": 942, "Severe": 1120, "Critical": 275, "Confirmed": 1569, "Emergencies": { "Suspected": 366, "Total": 2203, "Severe": 180 }, "MedicalActs": { "Suspected": 76, "Total": 480 } }, "geometry": { "type": "Point", "coordinates": [4.731409826897467, 47.2969232490013] } }, { "type": "Feature", "properties": { "Country/Region": "France", "Province/State": "Normandie", "Code": "28", "Population": { "Total": 3303500, "Under19": 781337, "Under39": 727044, "Under59": 842963, "Under74": 615474, "Over75": 336682 }, "Beds": { "Resuscitation": 240, "IntensiveCare": 548, "Total": 788 }, "Deaths": 111, "Recovered": 308, "Severe": 710, "Critical": 217, "Confirmed": 912, "Emergencies": { "Suspected": 141, "Total": 2543, "Severe": 52 }, "MedicalActs": { "Suspected": 170, "Total": 833 } }, "geometry": { "type": "Point", "coordinates": [-0.022673401869158984, 49.066630336448576] } }, { "type": "Feature", "properties": { "Country/Region": "France", "Province/State": "Hauts-de-France", "Code": "32", "Population": { "Total": 5962662, "Under19": 1525538, "Under39": 1443348, "Under59": 1522690, "Under74": 994313, "Over75": 476773 }, "Beds": { "Resuscitation": 438, "IntensiveCare": 1338, "Total": 1776 }, "Deaths": 520, "Recovered": 1153, "Severe": 2119, "Critical": 573, "Confirmed": 3011, "Emergencies": { "Suspected": 424, "Total": 3825, "Severe": 138 }, "MedicalActs": { "Suspected": 224, "Total": 1732 } }, "geometry": { "type": "Point", "coordinates": [2.8852615671641804, 49.86155781716422] } }, { "type": "Feature", "properties": { "Country/Region": "France", "Province/State": "Grand Est", "Code": "44", "Population": { "Total": 5511747, "Under19": 1258123, "Under39": 1291962, "Under59": 1448828, "Under74": 988178, "Over75": 524656 }, "Beds": { "Resuscitation": 465, "IntensiveCare": 840, "Total": 1305 }, "Deaths": 1471, "Recovered": 2953, "Severe": 4739, "Critical": 971, "Confirmed": 5479, "Emergencies": { "Suspected": 745, "Total": 3660, "Severe": 363 }, "MedicalActs": { "Suspected": 299, "Total": 1256 } }, "geometry": { "type": "Point", "coordinates": [5.509890203045682, 48.670969771573546] } }, { "type": "Feature", "properties": { "Country/Region": "France", "Province/State": "Pays de la Loire", "Code": "52", "Population": { "Total": 3801797, "Under19": 933509, "Under39": 853729, "Under59": 970508, "Under74": 667531, "Over75": 376520 }, "Beds": { "Resuscitation": 181, "IntensiveCare": 572, "Total": 753 }, "Deaths": 123, "Recovered": 441, "Severe": 667, "Critical": 181, "Confirmed": 1021, "Emergencies": { "Suspected": 229, "Total": 1919, "Severe": 105 }, "MedicalActs": { "Suspected": 133, "Total": 696 } }, "geometry": { "type": "Point", "coordinates": [-0.8763313771517983, 47.44186302034428] } }, { "type": "Feature", "properties": { "Country/Region": "France", "Province/State": "Bretagne", "Code": "53", "Population": { "Total": 3340379, "Under19": 773631, "Under39": 714512, "Under59": 866988, "Under74": 632104, "Over75": 353144 }, "Beds": { "Resuscitation": 162, "IntensiveCare": 462, "Total": 624 }, "Deaths": 81, "Recovered": 280, "Severe": 423, "Critical": 114, "Confirmed": 962, "Emergencies": { "Suspected": 152, "Total": 2107, "Severe": 48 }, "MedicalActs": { "Suspected": 75, "Total": 686 } }, "geometry": { "type": "Point", "coordinates": [-3.104342941176476, 48.146701189258316] } }, { "type": "Feature", "properties": { "Country/Region": "France", "Province/State": "Nouvelle-Aquitaine", "Code": "75", "Population": { "Total": 5999982, "Under19": 1293321, "Under39": 1274746, "Under59": 1561754, "Under74": 1177229, "Over75": 692932 }, "Beds": { "Resuscitation": 412, "IntensiveCare": 946, "Total": 1358 }, "Deaths": 120, "Recovered": 579, "Severe": 762, "Critical": 243, "Confirmed": 1007, "Emergencies": { "Suspected": 334, "Total": 3933, "Severe": 142 }, "MedicalActs": { "Suspected": 322, "Total": 1895 } }, "geometry": { "type": "Point", "coordinates": [0.16186906163753495, 45.156971701931916] } }, { "type": "Feature", "properties": { "Country/Region": "France", "Province/State": "Occitanie", "Code": "76", "Population": { "Total": 5924858, "Under19": 1320456, "Under39": 1330125, "Under59": 1526711, "Under74": 1099893, "Over75": 647673 }, "Beds": { "Resuscitation": 474, "IntensiveCare": 1206, "Total": 1680 }, "Deaths": 158, "Recovered": 757, "Severe": 1024, "Critical": 328, "Confirmed": 2374, "Emergencies": { "Suspected": 317, "Total": 4427, "Severe": 136 }, "MedicalActs": { "Suspected": 130, "Total": 804 } }, "geometry": { "type": "Point", "coordinates": [1.988214846153848, 43.761180626373644] } }, { "type": "Feature", "properties": { "Country/Region": "France", "Province/State": "Auvergne-Rhône-Alpes", "Code": "84", "Population": { "Total": 8032377, "Under19": 1940253, "Under39": 1900702, "Under59": 2079813, "Under74": 1340003, "Over75": 771606 }, "Beds": { "Resuscitation": 559, "IntensiveCare": 1136, "Total": 1695 }, "Deaths": 508, "Recovered": 1756, "Severe": 2983, "Critical": 779, "Confirmed": 2093, "Emergencies": { "Suspected": 687, "Total": 5425, "Severe": 321 }, "MedicalActs": { "Suspected": 271, "Total": 1272 } }, "geometry": { "type": "Point", "coordinates": [4.515179591651545, 45.475403602540794] } }, { "type": "Feature", "properties": { "Country/Region": "France", "Province/State": "Guadeloupe", "Code": "01", "Population": { "Total": 376879, "Under19": 90617, "Under39": 71707, "Under59": 109452, "Under74": 70936, "Over75": 34167 }, "Beds": { "Resuscitation": 27, "IntensiveCare": 68, "Total": 95 }, "Deaths": 8, "Recovered": 36, "Severe": 44, "Critical": 18, "Confirmed": 106, "Emergencies": { "Suspected": 4, "Total": 295, "Severe": 3 } }, "geometry": { "type": "Point", "coordinates": [-61.493846272189366, 16.20469674556213] } }, { "type": "Feature", "properties": { "Country/Region": "France", "Province/State": "Martinique", "Code": "02", "Population": { "Total": 358749, "Under19": 77005, "Under39": 65776, "Under59": 105638, "Under74": 72163, "Over75": 38167 }, "Beds": { "Resuscitation": 26, "IntensiveCare": 58, "Total": 84 }, "Deaths": 3, "Recovered": 37, "Severe": 64, "Critical": 21, "Confirmed": 111, "MedicalActs": { "Suspected": 9, "Total": 189 } }, "geometry": { "type": "Point", "coordinates": [-60.98265692913386, 14.6217557480315] } }, { "type": "Feature", "properties": { "Country/Region": "France", "Province/State": "Provence-Alpes-Côte d'Azur", "Code": "93", "Population": { "Total": 5055651, "Under19": 1128765, "Under39": 1109058, "Under59": 1309879, "Under74": 927347, "Over75": 580602 }, "Beds": { "Resuscitation": 460, "IntensiveCare": 802, "Total": 1262 }, "Deaths": 195, "Recovered": 1304, "Severe": 1722, "Critical": 435, "Confirmed": 1927, "Emergencies": { "Suspected": 360, "Total": 4212, "Severe": 204 }, "MedicalActs": { "Suspected": 228, "Total": 1294 } }, "geometry": { "type": "Point", "coordinates": [5.940587832647462, 43.96417941015098] } }, { "type": "Feature", "properties": { "Country/Region": "France", "Province/State": "Corse", "Code": "94", "Population": { "Total": 344679, "Under19": 68555, "Under39": 76985, "Under59": 93175, "Under74": 65675, "Over75": 40289 }, "Beds": { "Resuscitation": 18, "IntensiveCare": 42, "Total": 60 }, "Deaths": 26, "Recovered": 117, "Severe": 108, "Critical": 26, "Confirmed": 263, "Emergencies": { "Suspected": 95, "Total": 240, "Severe": 95 }, "MedicalActs": { "Suspected": 47, "Total": 133 } }, "geometry": { "type": "Point", "coordinates": [9.019688964401293, 42.118564077669916] } }, { "type": "Feature", "properties": { "Country/Region": "France", "Province/State": "Guyane", "Code": "03", "Population": { "Total": 290691, "Under19": 120681, "Under39": 80023, "Under59": 61783, "Under74": 22111, "Over75": 6093 }, "Beds": { "Resuscitation": 13, "IntensiveCare": 12, "Total": 25 }, "Recovered": 15, "Severe": 7, "Critical": 1, "Confirmed": 43, "Emergencies": { "Suspected": 3, "Total": 314, "Severe": 1 } }, "geometry": { "type": "Point", "coordinates": [-53.41731165390502, 3.588901056661561] } }, { "type": "Feature", "properties": { "Country/Region": "France", "Province/State": "La Réunion", "Code": "04", "Population": { "Total": 859959, "Under19": 256143, "Under39": 202783, "Under59": 239212, "Under74": 117045, "Over75": 44776 }, "Beds": { "Resuscitation": 52, "IntensiveCare": 154, "Total": 206 }, "Recovered": 41, "Severe": 57, "Critical": 6, "Confirmed": 94, "Emergencies": { "Suspected": 29, "Total": 568, "Severe": 29 } }, "geometry": { "type": "Point", "coordinates": [55.52943947368424, -21.1374047368421] } }, { "type": "Feature", "properties": { "Country/Region": "France", "Province/State": "Mayotte", "Code": "06", "Population": { "Total": 279471, "Under19": 150257, "Under39": 74348, "Under59": 42900, "Under74": 9521, "Over75": 2445 }, "Beds": { "Resuscitation": 6, "IntensiveCare": 0, "Total": 6 }, "Deaths": 2, "Recovered": 13, "Severe": 18, "Critical": 3, "Confirmed": 128, "Emergencies": { "Suspected": 22, "Total": 156, "Severe": 4 } }, "geometry": { "type": "Point", "coordinates": [45.14160071428572, -12.835344166666673] } }] }

/***************************************
 * 
 * 10/04/2020
 * Examen JavaScript G2M - durée 3h
 * 
 ***************************************/

/** 
 * OpenStreetMap
 * @type {module:ol/source/OSM}
 */
var osm = new ol.source.OSM();
var osmLayer = new ol.layer.Tile({
	source: osm
});

/** 
 * Couche vecteur point : épidémie COVID-19 par région
 * @type {module:ol/layer/Vector~Options}
 */
var vectorLayer = new ol.layer.Vector({
	source: new ol.source.Vector({
		features: (new ol.format.GeoJSON()).readFeatures(jsonObject) // Source JSON WGS84
	})
});
vectorLayer.getSource().getFeatures().forEach(function (feature) { // Reprojection des points de la couche en Web Mercator
	feature.setGeometry(
		new ol.geom.Point(ol.proj.fromLonLat([feature.getGeometry().getCoordinates()[0], feature.getGeometry().getCoordinates()[1]]))
	)
});

/**
 * 1. Service REST ArcGIS : World Street Map
 * @type {module:ol/source/TileArcGISRest~Options}
 */
var arcgis = new ol.source.TileArcGISRest({
	url: 'https://server.arcgisonline.com/arcgis/rest/services/World_Street_Map/MapServer'
});
var arcgisLayer = new ol.layer.Tile({ /** Couche raster tuilé OpenLayers */
	source: arcgis,
	visible: false /** 1. Par défaut : non visible */
});

/**
 * Carte
 * @type {module:ol/Map~Options}
 */
const map = new ol.Map({

	target: 'map', // Containeur HTML

	/* Tableaux des couches */
	layers: [
		osmLayer,
		arcgisLayer, /** 1. Ajout de la couche aux tableaux des couches */
		vectorLayer
	],

	/*
	 * Définition de la vue representant la carte
	 * Projection : defaults to 'EPSG:3857'
	 * @type {module:ol/source/TileArcGISRest~Options}
	 */
	view: new ol.View({
		center: ol.proj.fromLonLat([10, 17]),
		zoom: 3
	}),

	/** 2. Déclaration des contrôles de la carte */
	controls: ol.control.defaults().extend([

		/* Slider de zoom */
		new ol.control.ZoomSlider(),

		/* Zoom étendue */
		new ol.control.ZoomToExtent({
			extent: [-426273.983931, 5028292.113831, 1153526.421541, 6654057.246329] // france métropolitaine
		}),

		/* Mini-map */
		new ol.control.OverviewMap({
			layers: [
				new ol.layer.Tile({
					source: osm // OpenStreetMap
				})
			],
			className: "ol-overviewmap"
		}),

		/* Echelle */
		new ol.control.ScaleLine(),

	])

});

/**
 * 3. Déclaration de la fonction permettant d'afficher/masquer les couches
 * @param checkbox 
 */
function setVisibility(checkbox) {
	map.getLayers().forEach(function (layer) { /* Parcourir les couches */
		switch (checkbox.id) { /* selon l'id de la checkbox */

			/** 3. Checkbox OpenStreetMap */
			case 'cbOSM':
				if (layer.getSource() == osm) {
					layer.setVisible(checkbox.checked); /* Définir la visibilité de la couche OpenStreetMap */
				};
				if (layer.getSource() == arcgis) {
					layer.setVisible(!checkbox.checked); /* Définir la visibilité de la couche ArcGIS World Street Map */
					document.getElementById('cbTileArcGISRest').checked = !checkbox.checked; /* Définir si la case à cocher ArcGIS World Street Map est checked ou non */
				};
				break;

			/** 3. Checkbox ArcGIS World Street Map */
			case 'cbTileArcGISRest':
				if (layer.getSource() == arcgis) {
					layer.setVisible(checkbox.checked); /* Définir la visibilité de la couche ArcGIS World Street Map */
				};
				if (layer.getSource() == osm) {
					layer.setVisible(!checkbox.checked); /* Définir la visibilité de la couche OpenStreetMap */
					document.getElementById('cbOSM').checked = !checkbox.checked; /* Définir si la case à cocher OpenStreetMap est checked ou non */
				};
				break;
		}
	});
};

/**
 * 4. Déclaration des styles, images PNG
 * @type {module:ol/style/Icon~Options}
 */
var iconStyle8 = new ol.style.Style({ // 8px
	image: new ol.style.Icon({
		src: 'data/circle-8.png'
	})
});
var iconStyle16 = new ol.style.Style({ // 16px
	image: new ol.style.Icon({
		src: 'data/circle-16.png'
	})
});
var iconStyle32 = new ol.style.Style({ // 32px
	image: new ol.style.Icon({
		src: 'data/circle-32.png'
	})
});
var iconStyle64 = new ol.style.Style({ // 64px
	image: new ol.style.Icon({
		src: 'data/circle-64.png'
	})
});
var iconStyleUndefined = new ol.style.Style({ // 32px undefined
	image: new ol.style.Icon({
		src: 'data/undefined.png'
	})
});

/**
 * 4. Parcourir les entités de la couche vecteur
 * <Array>.forEach (ES6)
 */
vectorLayer.getSource().getFeatures().forEach(function (feature) {

	/* [0:100[ */
	if (feature.get('Deaths') < 100) {
		feature.setStyle(iconStyle8); /* Styliser avec l'image 8px */
	}
	/* [100:200[ */
	else if (feature.get('Deaths') >= 100 && feature.get('Deaths') < 200) {
		feature.setStyle(iconStyle16); /* Styliser avec l'image 16px */
	}
	/* [200:1000[ */
	else if (feature.get('Deaths') >= 200 && feature.get('Deaths') < 1000) {
		feature.setStyle(iconStyle32); /* Styliser avec l'image 32px */
	}
	/* [1000:infini] */
	else if (feature.get('Deaths') >= 1000) {
		feature.setStyle(iconStyle64); /* Styliser avec l'image 64px */
	}
	/* [autres valeurs] */
	else {
		feature.setStyle(iconStyleUndefined); /* Styliser avec l'image undefined */
	}

});

/**
 * 5. Création d'un objet ol.Overlay pour ancrer la popup sur la carte
 * @type {module:ol/Overlay~Options}
 */
var popup = new ol.Overlay({
	element: document.getElementById('popup') // <div>
});
map.addOverlay(popup);

/**
 * 5. Evénement 'click' sur la carte : Afficher la popup
 */
map.on('click', function (event) {

	/* Récupérer l'entité au niveau du pixel cliqué */
	var feature = map.forEachFeatureAtPixel(event.pixel,
		function (feature, layer) {
			return feature;
		}
	);

	/* Si une entité retournée */
	if (feature) {

		/* Afficher la popup */
		popup.setPosition(feature.getGeometry().getCoordinates());

		/* Contenu de la popup */
		document.getElementById('popup-content').innerHTML = "<p style='margin:0'><b>" + feature.get('Province/State') + "</b></p>"; // Nom région
		document.getElementById('popup-content').innerHTML += "<p style='margin:0'>Décès : " + feature.get('Deaths') + "</p>"; // Nbre décès

	}

	/* Si aucune entité retournée */
	else {

		/* Si popup ouverte, alors on masque la popup */
		if (document.getElementById('popup') != null) {
			popup.setPosition(undefined); // Masquer la popup
		}
	}
});